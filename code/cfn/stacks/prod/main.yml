AWSTemplateFormatVersion: 2010-09-09
Description: Driver template to deploy the vpc, security groups, load balancer, cloudfront distribution, iam roles, lambda function, s3 bucket, ssmParameter, cloudwatch rules, rds, and auto scaling Group
Parameters:
  project:
    Type: String
    Default: ippei
    Description:  Project Name
  env:
    Type: String
    Default: prod
    AllowedValues: [prod, dev, qa, stag]
    Description:  Environment Name
  app:
    Type: String
    Default: app
    Description: Name of the app
  dBUsername:
    Type: String
    NoEcho: true
    Description: Username for database access
  dBPassword:
    Type: String
    NoEcho: true
    Description: Password for database access
  s3ArtifactPath:
    Type: String
    Default: "https://ippei-prod-app-us-east-1-203352749099.s3.amazonaws.com/code/cfn/services"
    Description: "Artifacts bucket path"

Resources:
  vpc:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/vpc/vpc-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        vpcCidr: 10.20.0.0/16
        publicSubnet1Cidr: 10.20.1.0/24
        publicSubnet2Cidr: 10.20.2.0/24
        privateSubnet1Cidr: 10.20.3.0/24
        privateSubnet2Cidr: 10.20.4.0/24
        protectedSubnet1Cidr: 10.20.36.0/24
        protectedSubnet2Cidr: 10.20.37.0/24
        vpcDestinationCidrBlockPublicRoute: 0.0.0.0/0
        vpcDestinationCidrBlockPrivateRoute: 0.0.0.0/0
        vpcDestinationCidrBlockProtectedRoute: 0.0.0.0/0
        vpcNaclPublicInboundCidr: 0.0.0.0/0
        vpcNaclPublicOutboundCidr: 0.0.0.0/0
        vpcNaclPrivateInboundCidr: 0.0.0.0/0
        vpcNaclPrivateOutboundCidr: 0.0.0.0/0
        vpcNaclProtectedInboundCidr: 10.20.0.0/16
        vpcNaclProtectedOutboundCidr: 0.0.0.0/0
        publicIPActive: True
        vpcDnsEnabled: True
        vpcDnsSupport: True
  securityGroup:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - vpc
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/securitygroup/securitygroup-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        vpcId: !GetAtt vpc.Outputs.vpcId
        sgInternetTrafficIngressCidr: 0.0.0.0/0
        sgInternetTrafficEgressCidr: 0.0.0.0/0
        sgSshPort: 22
        sgHttpsPort: 443
        sgHttpPort: 80
        sgRdsPort: 3306
        sgAllowAllEgressProtocol: -1
        netsolCidrIp: 0.0.0.0/0
  ec2InstanceConnectEndpoint:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - vpc
      - securityGroup
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/ec2/ec2Endpoint-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        ec2EndpointClientToken: ec2InstanceConnectEndpoint # A unique, case-sensitive identifier to guarantee the idempotency of the request
        ec2EndpointPreserveClientIp: True
        ec2EndpointSg: !GetAtt securityGroup.Outputs.sgEc2ConnectEndpoint
        ec2EndpointSubnetId: !GetAtt vpc.Outputs.privateSubnet1
  jumpServer:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - vpc
      - securityGroup
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/ec2/ec2-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: jumpServer
        imageId: ami-04b70fa74e45c3917
        instanceType: t2.micro
        ec2SubnetId: !GetAtt vpc.Outputs.publicSubnet1
        ec2SShSecurityGroup: !GetAtt securityGroup.Outputs.sgEc2ConnectEndpoint
        keyPairName: !Sub "${project}-${env}-${app}-${AWS::Region}-${AWS::AccountId}"
        ebsVolumeSize: 8
        ebsVolumeType: gp3
        ebsMappingDevineName: /dev/xvda
  s3AlbAccessLogBucket:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/s3/s3-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: alb-logs
        s3BucketAccessControl: Private
        s3VersioningStatus: Enabled
        s3ObjectOwnership: BucketOwnerPreferred
        sseAlgorithm: AES256
        indexDocument: index.html
        errorDocument: error.html
        enableWebsiteConfiguration: no
        enableCfWritePolicy: no
        enableS3BucketPolicy: no 
        enableAlbBucketPolicy: yes
  applicationLoadBalancer:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - vpc
      - securityGroup
      - s3AlbAccessLogBucket
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/loadbalancer/lb-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        vpcId: !GetAtt vpc.Outputs.vpcId
        lbSecurityGroup: !GetAtt securityGroup.Outputs.sgPublicAlb
        lbSubnetIdA: !GetAtt vpc.Outputs.publicSubnet1
        lbSubnetIdB: !GetAtt vpc.Outputs.publicSubnet2
        loadBalancerName: !Sub "${env}loadBalancer"
        loadBalancerScheme: internet-facing
        healthCheckIntervalSeconds: 30
        healthCheckTimeoutSeconds: 15
        healthyThresholdCount: 5
        unHealthyThresholdCount: 3
        loadBalancerMethod: round_robin
        lbActionType: forward
        lbHttpPort: 80
        ipAddressType: ipv4
        lbHttpsPort: 443
        appCode: 200-499
        lbTargetType: instance
        statusCode: HTTP_301
        acmCertificateIdentifier: 7b7d8278-e046-4bac-8af2-1a1a31510ca2
        loadBalancerType: application
        lbHttpsListenerSslPolicy: ELBSecurityPolicy-TLS13-1-2-2021-06
        lbHttpsProtocol: HTTPS
        lbHttpProtocol: HTTP
        enableAccessLogs: True
        s3BucketNameForAccessLogs: !GetAtt s3AlbAccessLogBucket.Outputs.s3Bucket
        prefixOfS3BucketForAccessLogs: alb-logs
  s3CfAccessLogBucket:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/s3/s3-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: cf-logs
        s3BucketAccessControl: Private
        s3VersioningStatus: Enabled
        s3ObjectOwnership: BucketOwnerPreferred
        sseAlgorithm: AES256
        indexDocument: index.html
        errorDocument: error.html
        enableWebsiteConfiguration: no
        enableCfWritePolicy: no
        enableS3BucketPolicy: no 
        enableAlbBucketPolicy: yes
  ssmParameterStore:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/ssm/ssmParameterStore/ssmParameterStore-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        amiId: ami-0914585ea7964d53f
  iamRoles:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      # - s3ArtifactsBucket
      - freeMemSsmDocument
      - ssmParameterStore
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/iamRoles/iamRoles-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        # s3ArtifactsBucketArn: !GetAtt s3ArtifactsBucket.Outputs.s3BucketArn
        instanceIdsParamStoreName: !GetAtt ssmParameterStore.Outputs.instanceIdsParamStoreName
        dbName: !Sub "${project}-${env}-${app}-db-${AWS::Region}"
        asgName: !Sub "${project}-${env}-${app}-AutoScalingGroup"
        freeMemSsmDocumentName: !GetAtt freeMemSsmDocument.Outputs.freeMemSsmDocumentName
        amiIdParamStoreName: !GetAtt ssmParameterStore.Outputs.amiIdParamStoreName
  ec2Autoscaling:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - vpc
      - securityGroup
      - applicationLoadBalancer
      - iamRoles
      - ssmParameterStore
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/autoscaling/autoscaling-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        launchTemplateEc2ImageId: !GetAtt ssmParameterStore.Outputs.amiIdParamStoreValue
        ec2InstanceType: t3.medium
        keyPairName: !Sub "${project}-${env}-${app}-${AWS::Region}-${AWS::AccountId}"
        launchTemplateName: !Sub "${project}-${env}-${app}-asgLaunchTemplate"
        autoScalingGroupName: !Sub "${project}-${env}-${app}-AutoScalingGroup"
        privateSubnet1Id: !GetAtt vpc.Outputs.publicSubnet1
        privateSubnet2Id: !GetAtt vpc.Outputs.publicSubnet2
        autoScalingDesiredCapacity: 1
        autoScalingMaxSize: 2
        autoScalingMinSize: 1
        sgEc2Web: !GetAtt securityGroup.Outputs.sgEc2Web
        ebsVolumeSize: 200
        ebsVolumeType: gp3
        targetGroupArn: !GetAtt applicationLoadBalancer.Outputs.lbTargetGroupArn
        ec2InstanceProfileName: !GetAtt iamRoles.Outputs.ec2InstanceProfileName
        lifecycleHookDefaultResult: CONTINUE
        asgLifecycleTransition: autoscaling:EC2_INSTANCE_LAUNCHING
        lifecycleHeartbeatTimeout: 30
        stepScalingAdjustmentType: ChangeInCapacity
        stepScalingMetricAggregationType: Average
        asgPolicyType: StepScaling
        cpuScaleInMetricIntervalUpperBound: 0
        cpuScaleInAdjustment: -1
        cpuScaleOutMetricIntervalLowerBound: 0
        cpuScaleOutAdjustment: 1
        freeMemScaleInMetricIntervalLowerBound: 0
        freeMemScaleInAdjustment: -1
        freeMemScaleOutMetricIntervalUpperBound: 0
        freeMemScaleOutAdjustment: 1
        detailedMonitoring: true
        memUtilSSMParamStoreName: !GetAtt ssmParameterStore.Outputs.memUtilSSMParamStoreName
        diskUtilSSMParamStoreName: !GetAtt ssmParameterStore.Outputs.diskUtilSSMParamStoreName
        ssmAssociationName: !Sub "${project}-${env}-${app}-freeMem-${AWS::Region}"
        regionName: !Sub ${AWS::Region}
  cloudFrontDistribution:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - applicationLoadBalancer
      - s3CfAccessLogBucket
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/cloudfront/cloudfront-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        targetDns: !GetAtt applicationLoadBalancer.Outputs.lbDnsName
        viewerProtocolPolicy: redirect-to-https
        originProtocolPolicy: https-only
        cfDistributionStatus: true
        targetOriginId: !Sub "${env}-LoadBalancerOrigin"
        defaultTTL: 86400
        maxTTL: 259300
        minTTL: 86400
        acmCertificateIdentifier: 7b7d8278-e046-4bac-8af2-1a1a31510ca2
        cfHttpsPort: 443
        cfOriginSSLProtocols: TLSv1.2
        cfAlias: ippei.netsolcloudservices.com
        # cfAlias2: .goldirahedge.com
        # cfAlias3: *.goldirahedge.com
        cfOriginRequestPolicyId: 216adef6-5c7f-47e4-b989-5492eafa07d3
        cfResponseHeadersPolicyId: 67f7725c-6f97-4210-82d7-5512b31e9d03
        cfHttpVersion: http2
        cfPriceClass: PriceClass_100
        acmCertificateProtocolVersion: TLSv1.2_2021
        acmCertificateSslSupportMethod: sni-only
        cfCachePolicyConfigComment: TTL for cache in cloudfront
        cfCachePolicyConfigName: !Sub "${project}-${env}-${app}-CloudfrontCacheRequestPolicy"
        cfCachePolicyCookieBehavior: all
        cfCachePolicyHeaderBehavior: whitelist
        s3CfAccessLogBucketDomainName: !GetAtt s3CfAccessLogBucket.Outputs.s3BucketDomainName
        accessLogCookies: true
        accessLogPrefix: cloudFrontAccessLogs/
        cfDistComment: CDN for ippei
        cfEnableLogs: True
        cfCacheDisablePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad
        cfEnableCacheRequestPolicy: no
        # cfEnableAlias: yes
  rdsDbInstance:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - vpc
      - securityGroup
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/rds/rds-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        dBInstanceIdentifier: db
        dbName: ""
        dBSnapshotIdentifier: migrated-rds-theme-us-east-1-203352749099
        dBInstanceClass: db.t3.micro
        dbPrivateSubnet01: !GetAtt vpc.Outputs.protectedSubnet1
        dbPrivateSubnet02: !GetAtt vpc.Outputs.protectedSubnet2
        dbSecurityGroup: !GetAtt securityGroup.Outputs.sgRds
        dbEncryptionStatus: true
        dbPubliclyAccessible: false
        dbStorageType: gp2
        dbDeletionProtection: true
        dBAllocatedStorage: 100
        dBEngine: MariaDB
        dBUsername: !Ref dBUsername
        dBPassword: !Ref dBPassword
        dbEngineVersion: 10.4.32
        dbPort: 3306
        # kmsKeyId: 
  freeMemSsmDocument:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/ssm/ssmDocument/ssmDocument-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        ssmDocumentName: freeMem
        ssmDocumentFormat: JSON
        ssmDocumentType: Command
        ssmDocumentTargetType: /AWS::EC2::Instance
        ssmSchemaVersion: "2.2"
        ssmDocumentDescription: "Execute Custom CloudWatch Metric Script"
        scriptFileName: !Sub "${env}_free_memory.sh"
        awsRegion: !Sub ${AWS::Region}
        cwCustomNamespace: Custom-CloudWeb-Metrics
        freeMemoryMetricName: !Sub "${env}_free_mem_ec2"
        freeMemoryMetricUnit: Percent
        autoScalingGroupName: !Sub "${project}-${env}-${app}-AutoScalingGroup"
        ssmDocUpdateMethod: Replace
  updateInstanceIdLambdaFunc:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - iamRoles
      - ec2Autoscaling
      - snsTopicForCwAlarms
      - ssmParameterStore
      - rdsDbInstance
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/lambdaFunction/lambdaFunction-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        lambdaFunctionName: !Sub "${project}-${env}-${app}-updateInstanceId-${AWS::Region}"
        runtimeVersion: python3.10
        lambdaHandler: updateInstanceId.lambda_handler
        timeout: 30
        lambdaExecutionRoleArn: !GetAtt iamRoles.Outputs.lambdaRoleForUpdateInstanceIdFunctionArn
        s3BucketName: !Sub "${project}-${env}-${app}-${AWS::Region}-${AWS::AccountId}"
        s3Key: code/lambda/updateInstanceId/updateInstanceId.zip
        launchTemplateName: !Sub "${project}-${env}-${app}-asgLaunchTemplate"
        instanceIdsParamStore: !Sub "${project}-${env}-${app}-instanceIdParamStore-${AWS::Region}"
        asgName: !Sub "${project}-${env}-${app}-AutoScalingGroup"
        scaleInPolicyName: !Sub "${project}-${env}-${app}-cpuScaleInStepScalingPolicy"
        freeMemScaleInStepScalingPolicyArn: !GetAtt ec2Autoscaling.Outputs.freeMemScaleInStepScalingPolicyArn
        freeMemScaleOutStepScalingPolicyArn: !GetAtt ec2Autoscaling.Outputs.freeMemScaleOutStepScalingPolicyArn
        snsTopicArn: !GetAtt snsTopicForCwAlarms.Outputs.snsTopicArn
        amiIdParamStoreName: !GetAtt ssmParameterStore.Outputs.amiIdParamStoreName
        dBInstanceName: !GetAtt rdsDbInstance.Outputs.dBInstanceIdentifier
  createAmiLambdaFunc:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - iamRoles
      - ec2Autoscaling
      - snsTopicForCwAlarms
      - ssmParameterStore
      - rdsDbInstance
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/lambdaFunction/lambdaFunction-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        lambdaFunctionName: !Sub "${project}-${env}-${app}-createAmi-${AWS::Region}"
        runtimeVersion: python3.10
        lambdaHandler: createAmi.lambda_handler
        timeout: 30
        lambdaExecutionRoleArn: !GetAtt iamRoles.Outputs.lambdaRoleForCreateAmiFunctionArn
        s3BucketName: !Sub "${project}-${env}-${app}-${AWS::Region}-${AWS::AccountId}"
        s3Key: code/lambda/createAmi/createAmi.zip
        launchTemplateName: !Sub "${project}-${env}-${app}-asgLaunchTemplate"
        instanceIdsParamStore: !Sub "${project}-${env}-${app}-instanceIdParamStore-${AWS::Region}"
        asgName: !Sub "${project}-${env}-${app}-AutoScalingGroup"
        scaleInPolicyName: !Sub "${project}-${env}-${app}-cpuScaleInStepScalingPolicy"
        freeMemScaleInStepScalingPolicyArn: !GetAtt ec2Autoscaling.Outputs.freeMemScaleInStepScalingPolicyArn
        freeMemScaleOutStepScalingPolicyArn: !GetAtt ec2Autoscaling.Outputs.freeMemScaleOutStepScalingPolicyArn
        snsTopicArn: !GetAtt snsTopicForCwAlarms.Outputs.snsTopicArn
        amiIdParamStoreName: !GetAtt ssmParameterStore.Outputs.amiIdParamStoreName
        dBInstanceName: !GetAtt rdsDbInstance.Outputs.dBInstanceIdentifier
  updateAsgLaunchTemplateLambdaFunc:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - iamRoles
      - ec2Autoscaling
      - snsTopicForCwAlarms
      - ssmParameterStore
      - rdsDbInstance
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/lambdaFunction/lambdaFunction-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        lambdaFunctionName: !Sub "${project}-${env}-${app}-updateAsgLaunchTemplate-${AWS::Region}"
        runtimeVersion: python3.10
        lambdaHandler: updateAsgLaunchTemplate.lambda_handler
        timeout: 30
        lambdaExecutionRoleArn: !GetAtt iamRoles.Outputs.lambdaRoleForAsgLaunchTemplateArn
        s3BucketName: !Sub "${project}-${env}-${app}-${AWS::Region}-${AWS::AccountId}"
        s3Key: code/lambda/updateAsgLaunchTemplate/updateAsgLaunchTemplate.zip
        launchTemplateName: !Sub "${project}-${env}-${app}-asgLaunchTemplate"
        instanceIdsParamStore: !Sub "${project}-${env}-${app}-instanceIdParamStore-${AWS::Region}"
        asgName: !Sub "${project}-${env}-${app}-AutoScalingGroup"
        scaleInPolicyName: !Sub "${project}-${env}-${app}-cpuScaleInStepScalingPolicy"
        freeMemScaleInStepScalingPolicyArn: !GetAtt ec2Autoscaling.Outputs.freeMemScaleInStepScalingPolicyArn
        freeMemScaleOutStepScalingPolicyArn: !GetAtt ec2Autoscaling.Outputs.freeMemScaleOutStepScalingPolicyArn
        snsTopicArn: !GetAtt snsTopicForCwAlarms.Outputs.snsTopicArn
        amiIdParamStoreName: !GetAtt ssmParameterStore.Outputs.amiIdParamStoreName
        dBInstanceName: !GetAtt rdsDbInstance.Outputs.dBInstanceIdentifier
  triggerScaleInAsgLambdaFunc:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - iamRoles
      - ec2Autoscaling
      - snsTopicForCwAlarms
      - ssmParameterStore
      - rdsDbInstance
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/lambdaFunction/lambdaFunction-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        lambdaFunctionName: !Sub "${project}-${env}-${app}-triggerScaleInAsg-${AWS::Region}"
        runtimeVersion: python3.10
        lambdaHandler: triggerScaleInAsg.lambda_handler
        timeout: 30
        lambdaExecutionRoleArn: !GetAtt iamRoles.Outputs.lambdaRoleForTriggerScaleInAsgFuncArn
        s3BucketName: !Sub "${project}-${env}-${app}-${AWS::Region}-${AWS::AccountId}"
        s3Key: code/lambda/triggerScaleInAsg/triggerScaleInAsg.zip
        launchTemplateName: !Sub "${project}-${env}-${app}-asgLaunchTemplate"
        instanceIdsParamStore: !Sub "${project}-${env}-${app}-instanceIdParamStore-${AWS::Region}"
        asgName: !Sub "${project}-${env}-${app}-AutoScalingGroup"
        scaleInPolicyName: !Sub "${project}-${env}-${app}-cpuScaleInStepScalingPolicy"
        freeMemScaleInStepScalingPolicyArn: !GetAtt ec2Autoscaling.Outputs.freeMemScaleInStepScalingPolicyArn
        freeMemScaleOutStepScalingPolicyArn: !GetAtt ec2Autoscaling.Outputs.freeMemScaleOutStepScalingPolicyArn
        snsTopicArn: !GetAtt snsTopicForCwAlarms.Outputs.snsTopicArn
        amiIdParamStoreName: !GetAtt ssmParameterStore.Outputs.amiIdParamStoreName
        dBInstanceName: !GetAtt rdsDbInstance.Outputs.dBInstanceIdentifier
  snsTopicForCwAlarms:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/sns/snsTopic/snsTopic-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        snsTopicName: !Sub "${project}-${env}-${app}-cwAlarmNotification-${AWS::Region}"
        snsDisplayName: !Sub "${project}-${env}-${app}-cwAlarmNotification-${AWS::Region}"
  snsTopicForTriggerScaleInAsgLambdaFunc:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/sns/snsTopic/snsTopic-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        snsTopicName: !Sub "${project}-${env}-${app}-scaleInAsgLambda-${AWS::Region}"
        snsDisplayName: !Sub "${project}-${env}-${app}-scaleInAsgLambda-${AWS::Region}"
  cloudwatchEventRules:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - updateInstanceIdLambdaFunc
      - updateAsgLaunchTemplateLambdaFunc
      - triggerScaleInAsgLambdaFunc
      - snsTopicForTriggerScaleInAsgLambdaFunc
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/cw/eventRules/cloudWatchEventRules-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        autoScalingGroupName: !Sub "${project}-${env}-${app}-AutoScalingGroup"
        updateInstanceIdLambdaFunctionArn: !GetAtt updateInstanceIdLambdaFunc.Outputs.lambdaFunctionArn
        updateInstanceIdCWEventRuleState: ENABLED
        eventPatternSource: aws.autoscaling
        eventPatternDetailType: EC2 Instance-launch Lifecycle Action
        ec2EventPatternSource: aws.ec2
        amiStateChangeDetailType: EC2 AMI State Change
        amiState: available
        ec2AmiStateChangeCwEventRuleState: ENABLED
        asgLaunchTemplateLambdaFunctionArn: !GetAtt updateAsgLaunchTemplateLambdaFunc.Outputs.lambdaFunctionArn
        triggerScaleInAsgLambdaFuncName: !GetAtt triggerScaleInAsgLambdaFunc.Outputs.lambdaFunctionName
        snsTopicForTriggerScaleInAsgLambdaFuncArn: !GetAtt snsTopicForTriggerScaleInAsgLambdaFunc.Outputs.snsTopicArn
        startScheduleExpression: cron(0 6 * * ? *)
        stopScheduleExpression: cron(2 15 * * ? *)
        startAction: start
        stopAction: stop
        cwStartEventRuleState: ENABLED
        cwStopEventRuleState: ENABLED
        # rdsStartStopLambdaFunctionArn: !GetAtt rdsStartStopLambdaFunc.Outputs.lambdaFunctionArn
        # ec2StartStopLambdaFunctionArn: !GetAtt ec2StartStopLambdaFunc.Outputs.lambdaFunctionArn
        updateInstanceIdCwEventRuleName: !Sub '${project}-${env}-${app}-eventRuleTriggerUpdateInstanceId-${AWS::Region}'
        ec2AmiStateChangeCwEventRuleName: !Sub '${project}-${env}-${app}-ec2AmiStateChangeCwEventRule-${AWS::Region}'
  snsSubscrip1ForCwAlarms:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - snsTopicForCwAlarms
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/sns/snsSubscription/snsSubscription-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        endpoint: uzairmansoor200@gmail.com
        protocol: email
        snsTopicArn: !GetAtt snsTopicForCwAlarms.Outputs.snsTopicArn
        snsSubscripExportName: snsSubscrip1ForCwAlarms
  snsSubscripForTriggerScaleInAsgLambdaFunc:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - snsTopicForTriggerScaleInAsgLambdaFunc
      - triggerScaleInAsgLambdaFunc
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/sns/snsSubscription/snsSubscription-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        endpoint: !GetAtt triggerScaleInAsgLambdaFunc.Outputs.lambdaFunctionArn
        protocol: lambda
        snsTopicArn: !GetAtt snsTopicForTriggerScaleInAsgLambdaFunc.Outputs.snsTopicArn
        snsSubscripExportName: snsSubscripForTriggerScaleInAsgLambdaFunc
  ec2CustomAlarms:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - snsTopicForCwAlarms
      - ec2Autoscaling
      - snsTopicForTriggerScaleInAsgLambdaFunc
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/cw/alarms/ec2CustomAlarm-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        lowEc2DiskUtilizationAlarmName: lowEc2DiskUtilizationAlarm
        mediumEc2DiskUtilizationAlarmName: mediumEc2DiskUtilizationAlarm
        highEc2DiskUtilizationAlarmName: highEc2DiskUtilizationAlarm
        diskUtilizationMetricName: DiskUtilization
        customMetricsNamespace: CWAgent
        diskUtilizationStatistic: Maximum
        ec2StatisticPeriod: 300
        ec2EvaluationPeriod: 3
        lowDiskUtilizationThresholdValue: 70
        mediumDiskUtilizationThresholdValue: 80 
        highDiskUtilizationThresholdValue: 90
        snsTopicArn: !GetAtt snsTopicForCwAlarms.Outputs.snsTopicArn
        snsTopicForTriggerScaleInAsgLambdaFuncArn: !GetAtt snsTopicForTriggerScaleInAsgLambdaFunc.Outputs.snsTopicArn
        freeMemScaleInStepScalingPolicyArn: !GetAtt ec2Autoscaling.Outputs.freeMemScaleInStepScalingPolicyArn
        freeMemScaleOutStepScalingPolicyArn: !GetAtt ec2Autoscaling.Outputs.freeMemScaleOutStepScalingPolicyArn
        freeMemoryStatisticPeriod: 60
        freeMemoryMetricName: !Sub "${env}_free_mem_ec2"
        highfreeMemoryThresholdValue: 10
        cloudWebCustomMetricsNamespace: Custom-CloudWeb-Metrics
        freeMemoryEvaluationPeriod: 3
        highEc2FreeMemoryAlarmName: highEc2FreeMemoryAlarm
        freeMemoryStatistic: Maximum
        ec2FreeMemScaleInAlarmName: ec2FreeMemScaleInAlarm
        lowEc2FreeMemoryAlarmName: lowEc2FreeMemoryAlarm
        lowfreeMemoryThresholdValue: 30
        mediumfreeMemoryThresholdValue: 20
        highfreeMemoryThresholdValue: 10
        ec2FreeMemScaleInThresholdValue: 70
        asgName: !Sub "${project}-${env}-${app}-AutoScalingGroup"
        deviceName: xvda1
        fileSystemType: ext4
        mediumEc2FreeMemoryAlarmName: mediumEc2FreeMemoryAlarm
  asgCloudWatchAlarm:
    Type: AWS::CloudFormation::Stack 
    DependsOn:
      - snsTopicForCwAlarms
      - ec2Autoscaling
      - snsTopicForTriggerScaleInAsgLambdaFunc
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/cw/alarms/asgAlarm-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        lowCpuAlarmName: !Sub "${project}-${env}-${app}-asgLowCpuAlarm-${AWS::Region}"
        mediumCpuAlarmName: !Sub "${project}-${env}-${app}-asgMediumCpuAlarm-${AWS::Region}"
        highCpuAlarmName: !Sub "${project}-${env}-${app}-asgHighCpuAlarm-${AWS::Region}"
        asgCpuScaleInAlarmName: cpuScaleInAlarm
        asgNamespace: AWS/EC2
        cpuMetricName: CPUUtilization
        asgCpuStatistic: Average
        cpuMetricUnit: Percent
        lowCpuThresholdValue: 70
        mediumCpuThresholdValue: 80
        highCpuThresholdValue: 90
        scaleInCpuThresholdValue: 50      
        asgNetworkOutTrafficAlarmName: !Sub "${project}-${env}-${app}-asgNetworkOutTrafficAlarm-${AWS::Region}"
        asgNetworkInTrafficAlarmName: !Sub "${project}-${env}-${app}-asgNetworkInTrafficAlarm-${AWS::Region}"
        asgNetworkInMetricName: NetworkIn
        asgNetworkOutMetricName: NetworkOut
        asgNetworkThresholdValue: 500586437
        asgNetworkMetricUnit: Bytes
        asgNetworkStatistic: Average
        systemStatusCheckMetricName: StatusCheckFailed
        statusCheckMetricName: StatusCheckFailed_Instance
        systemStatusCheckEc2AlarmName: !Sub "${project}-${env}-${app}-systemStatusCheckEc2Alarm-${AWS::Region}"
        statusCheckEc2AlarmName: !Sub "${project}-${env}-${app}-statusCheckEc2Alarm-${AWS::Region}"
        statusCheckStatistic: Sum
        statusCheckThresholdValue: 1
        statusCheckMetricUnit: Count
        snsTopicArn: !GetAtt snsTopicForCwAlarms.Outputs.snsTopicArn
        asgName: !Sub "${project}-${env}-${app}-AutoScalingGroup"
        asgStatisticPeriod: 60
        asgEvaluationPeriod: 3
        asgNetworkInStatisticPeriod: 900
        snsTopicForTriggerScaleInAsgLambdaFuncArn: !GetAtt snsTopicForTriggerScaleInAsgLambdaFunc.Outputs.snsTopicArn
        cpuScaleInStepScalingPolicyArn: !GetAtt ec2Autoscaling.Outputs.cpuScaleInStepScalingPolicyArn
        cpuScaleOutStepScalingPolicyArn: !GetAtt ec2Autoscaling.Outputs.cpuScaleOutStepScalingPolicyArn 
  albCloudWatchAlarm:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - snsTopicForCwAlarms
      - applicationLoadBalancer
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/cw/alarms/albAlarm-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        alb4xxErrorsMetricName: HTTPCode_Target_4XX_Count
        albUnhealthyHostMetricName: UnHealthyHostCount
        alb5xxErrorsMetricName: HTTPCode_Target_5XX_Count
        alb4xxErrorsAlarmName: !Sub "${project}-${env}-${app}-alb4xxErrorsAlarm-${AWS::Region}"
        alb5xxErrorsAlarmName: !Sub "${project}-${env}-${app}-alb5xxErrorsAlarm-${AWS::Region}"
        albUnhealthyHostAlarmName: !Sub "${project}-${env}-${app}-albUnhealthyHost-${AWS::Region}"
        albErrorsStatistic: Sum
        albMetricUnit: Count
        albThresholdValue: 0
        albUnhealthyHostStatistic: Minimum
        albNamespace: AWS/ApplicationELB
        snsTopicArn: !GetAtt snsTopicForCwAlarms.Outputs.snsTopicArn
        loadBalancerName: !GetAtt applicationLoadBalancer.Outputs.lbFullName
        targetGroupName: !GetAtt applicationLoadBalancer.Outputs.lbTargetGroupFullName
        albStatisticPeriod: 30
        albEvaluationPeriods: 3
        alb4xxErrorsStatisticPeriod: 900
        alb4xxErrorsEvaluationPeriods: 20
        alb4xxErrorsThresholdValue: 80
  cloudfrontCloudWatchAlarm:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - snsTopicForCwAlarms
      - cloudFrontDistribution
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/cw/alarms/cloudFrontAlarm-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        region: Global
        cloudfrontAlarmName: cfTotalErrorRateAlarm
        snsTopicArn: !GetAtt snsTopicForCwAlarms.Outputs.snsTopicArn
        cloudfrontDistributionId: !GetAtt cloudFrontDistribution.Outputs.cloudFrontDistributionId
        cloudfrontMetricName: TotalErrorRate
        cloudfrontNamespace: AWS/CloudFront
        cloudfrontStatistic: Average
        cloudfrontStatisticPeriod: 900
        cloudfrontEvaluationperiods: 20
        cloudfrontMetricUnit: Percent
        cloudfrontTotalErrorRateThreshold: 80
        region: Global
  rdsCloudWatchAlarm:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - rdsDbInstance
      - snsTopicForCwAlarms
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/cw/alarms/rdsAlarm-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        snsTopicArn: !GetAtt snsTopicForCwAlarms.Outputs.snsTopicArn
        dBInstanceName: !GetAtt rdsDbInstance.Outputs.dBInstanceIdentifier
        lowRdsStorageAlarmName: lowRdsStorageAlarm
        mediumRdsStorageAlarmName: mediumRdsStorageAlarm
        highRdsStorageAlarmName: highRdsStorageAlarm
        freeStorageSpaceMetricName: FreeStorageSpace
        lowRdsCpuAlarmName: lowRdsCpuAlarm
        mediumRdsCpuAlarmName: mediumRdsCpuAlarm
        highRdsCpuAlarmName: highRdsCpuAlarm
        cpuUtilizationMetricName: CPUUtilization
        rdsNamespace: AWS/RDS
        rdsFreeStorageStatistic: Minimum
        rdsFreeStorageMetricUnit: Bytes
        rdsLowStorageThreshold: 8192
        rdsMediumStorageThreshold: 6144
        rdsHighStorageThreshold: 4096
        rdsCpuUtilizationStatistic: Average
        rdsCpuUtilizationMetricUnit: Percent
        rdsMediumCpuUtilizationThreshold: 80
        rdsLowCpuUtilizationThreshold: 70
        rdsHighCpuUtilizationThreshold: 90
        rdsStatisticPeriod: 60
        rdsEvaluationPeriods: 3
  rdsBackup:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - iamRoles
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/backup/backup-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        newBackupVault: true
        backupVaultName: rds
        backupPlanName: rdsbackup
        backupSelectionName: rds
        backupPolicy: BackupOnceDaily
        backupIamRoleArn: !GetAtt iamRoles.Outputs.backupIamRoleArn
        backupDeleteAfterDays: 7
        backupTargetRegion: us-west-1
        backukScheduleExpression: cron(0 4 ? * * *)
        backupStartWindowMinutes: 60
        backupCompletionWindowMinutes: 120
        awsResource: DB
  ec2Backup:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - iamRoles
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/backup/backup-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        app: !Ref app
        newBackupVault: true
        backupVaultName: ec2
        backupPlanName: ec2backup
        backupSelectionName: ec2
        backupPolicy: BackupOnceDaily
        backupIamRoleArn: !GetAtt iamRoles.Outputs.backupIamRoleArn
        backupDeleteAfterDays: 7
        backupTargetRegion: us-west-1
        backukScheduleExpression: cron(0 4 ? * * *)
        backupStartWindowMinutes: 60
        backupCompletionWindowMinutes: 120
        awsResource: ec2Instance
Outputs:
  vpcId:
    Value: !Ref vpc
    Export:
      Name: !Sub "${project}-${env}-${app}-vpcStack-${AWS::Region}"
  securityGroup:
    Value: !Ref securityGroup
    Export:
      Name: !Sub "${project}-${env}-${app}-securityGroupStack-${AWS::Region}"
  applicationLoadBalancer:
    Value: !Ref applicationLoadBalancer
    Export:
      Name: !Sub "${project}-${env}-${app}-applicationLoadBalancerStack-${AWS::Region}"
#   s3ArtifactsBucket:
#     Value: !Ref s3ArtifactsBucket
#     Export:
#       Name: !Sub "${project}-${env}-${app}-s3ArtifactsBucketStack-${AWS::Region}"
  s3CfAccessLogBucket:
    Value: !Ref s3CfAccessLogBucket
    Export:
      Name: !Sub "${project}-${env}-${app}-s3CfAccessLogBucketStack-${AWS::Region}"
  iamRoles:
    Value: !Ref iamRoles
    Export:
      Name: !Sub "${project}-${env}-${app}-iamRolesStack-${AWS::Region}"
  ec2Autoscaling:
    Value: !Ref ec2Autoscaling
    Export:
      Name: !Sub "${project}-${env}-${app}-ec2AutoscalingStack-${AWS::Region}"
  cloudFrontDistribution:
    Value: !Ref cloudFrontDistribution
    Export:
      Name: !Sub "${project}-${env}-${app}-cloudFrontDistributionStack-${AWS::Region}"
  rdsDbInstance:
    Value: !Ref rdsDbInstance
    Export:
      Name: !Sub "${project}-${env}-${app}-rdsDbInstanceStack-${AWS::Region}"
  ssmParameterStore:
    Value: !Ref ssmParameterStore
    Export:
      Name: !Sub "${project}-${env}-${app}-ssmParameterStoreStack-${AWS::Region}"
  freeMemSsmDocument:
    Value: !Ref freeMemSsmDocument
    Export:
      Name: !Sub "${project}-${env}-${app}-freeMemSsmDocumentStack-${AWS::Region}"
  updateInstanceIdLambdaFunc:
    Value: !Ref updateInstanceIdLambdaFunc
    Export:
      Name: !Sub '${project}-${env}-${app}-updateInstanceIdLambdaFuncStack-${AWS::Region}' 
  createAmiLambdaFunc:
    Value: !Ref createAmiLambdaFunc
    Export:
      Name: !Sub '${project}-${env}-${app}-createAmiLambdaFuncStack-${AWS::Region}'  
  updateAsgLaunchTemplateLambdaFunc:
    Value: !Ref updateAsgLaunchTemplateLambdaFunc
    Export:
      Name: !Sub '${project}-${env}-${app}-updateAsgLaunchTemplateLambdaFuncStack-${AWS::Region}'
  triggerScaleInAsgLambdaFunc:
    Value: !Ref triggerScaleInAsgLambdaFunc
    Export:
      Name: !Sub '${project}-${env}-${app}-triggerScaleInAsgLambdaFuncStack-${AWS::Region}'
  cloudWatchEventRules:
    Value: !Ref cloudwatchEventRules
    Export:
      Name: !Sub "${project}-${env}-${app}-cloudWatchEventRulesStack-${AWS::Region}"
  snsTopicForCwAlarms:
    Value: !Ref snsTopicForCwAlarms
    Export:
      Name: !Sub "${project}-${env}-${app}-snsTopicForCwAlarmsStack-${AWS::Region}"
  snsTopicForTriggerScaleInAsgLambdaFunc:
    Value: !Ref snsTopicForTriggerScaleInAsgLambdaFunc
    Export:
      Name: !Sub "${project}-${env}-${app}-snsTopicForTriggerScaleInAsgLambdaFuncStack-${AWS::Region}"
  snsSubscrip1ForCwAlarms:
    Value: !Ref snsSubscrip1ForCwAlarms
    Export:
      Name: !Sub "${project}-${env}-${app}-snsSubscrip1ForCwAlarmsStack-${AWS::Region}"
  snsSubscripForTriggerScaleInAsgLambdaFunc:
    Value: !Ref snsSubscripForTriggerScaleInAsgLambdaFunc
    Export:
      Name: !Sub "${project}-${env}-${app}-snsSubscripForTriggerScaleInAsgLambdaFuncStack-${AWS::Region}"
  ec2CustomAlarms:
    Value: !Ref ec2CustomAlarms
    Export:
      Name: !Sub "${project}-${env}-${app}-ec2CustomAlarmsStack-${AWS::Region}"  
  asgCloudWatchAlarm:
    Value: !Ref asgCloudWatchAlarm
    Export:
      Name: !Sub "${project}-${env}-${app}-asgCloudWatchAlarmStack-${AWS::Region}"
  albCloudWatchAlarm:
    Value: !Ref albCloudWatchAlarm
    Export:
      Name: !Sub "${project}-${env}-${app}-albCloudWatchAlarmStack-${AWS::Region}"
  cloudfrontCloudWatchAlarm:
    Value: !Ref cloudfrontCloudWatchAlarm
    Export:
      Name: !Sub "${project}-${env}-${app}-cloudfrontCloudWatchAlarmStack-${AWS::Region}"
  # rdsCloudWatchAlarm:
  #   Value: !Ref rdsCloudWatchAlarm
  #   Export:
  #     Name: !Sub "${project}-${env}-${app}-rdsCloudWatchAlarmStack-${AWS::Region}"
  rdsBackup:
    Value: !Ref rdsBackup
    Export:
      Name: !Sub "${project}-${env}-${app}-rdsBackupStack-${AWS::Region}"
  ec2Backup:
    Value: !Ref ec2Backup
    Export:
      Name: !Sub "${project}-${env}-${app}-ec2BackupStack-${AWS::Region}"