AWSTemplateFormatVersion: "2010-09-09"
Description: Cfn driver template to deploy WAF
Parameters:
  project:
    Type: String
    Default: ippei
    Description: Project name
  env:
    Type: String
    Default: stage
    AllowedValues: [prod, dev, qa, stage]
    Description: Environment name
  app:
    Type: String
    Default: app
    Description: Name of the app
  s3ArtifactPath:
    Type: String
    Default: "https://ippei-wordpress-prod-us-east-1-770760105158.s3.amazonaws.com/code/cfn/services"
    Description: Artifact bucket path

Resources:
  wafWebAcl:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - cloudWebApplicationLoadBalancer
    Properties:
      TemplateURL: !Sub "${s3ArtifactPath}/waf/waf-app.yml"
      Parameters:
        project: !Ref project
        env: !Ref env
        wafWebAclName: !Sub "${project}-${env}-${app}-wafWebAcl-${AWS::Region}"
        wafWebAclDescription: "Web ACL for Application Load Balancer"
        wafWebAclScope: "REGIONAL"
        wafEnableSqlInjectionRule: true
        wafEnableCrossSiteScriptingRule: true
        wafEnableAmazonIpDdosProtectionRule: true
        wafEnableCoreRuleSet: true
        wafEnableKnownBadInputsRuleSet: true
        wafEnableLinuxRuleSet: true
        wafEnablePHPRuleSet: true
        wafEnableSQLiRuleSet: true
        wafEnableWordPressRuleSet: true 
        wafEnableAdminProtectionRuleSet: true
        applicationLoadBalancerArn: !GetAtt cloudWebApplicationLoadBalancer.Outputs.loadBalancerArn

Outputs:
  wafWebAcl:
    Value: !Ref wafWebAcl
    Export: 
      Name: !Sub "${project}-${env}-${app}-wafStack-${AWS::Region}"